<!DOCTYPE html>
<html>
<head>
    <title>Crawl Stories</title>
    <!-- Include Tailwind CSS via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-8">
    <form method="post" id="crawlForm" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
        {% csrf_token %}
        {% for field in form %}
            <div class="mb-4">
                <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-2">
                    {{ field.label }}
                </label>
                {{ field }}
            </div>
        {% endfor %}
        <button type="submit" id="submitBtn"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
            Crawl Stories
        </button>
        <div id="subprocessStatus" class="mt-2"></div>
    </form>

    <h2 id="outputLabel" class="text-xl font-bold py-2">Subprocess Output:</h2>
    <div id="subprocessOutput" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4 overflow-y-auto"
         style="max-height: 300px;"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const socket = location.protocol === 'https:'
            ? new WebSocket(`wss://${window.location.host}/ws/subprocess/`)
            : new WebSocket(`ws://${window.location.host}/ws/subprocess/`);
        const submitBtn = document.getElementById('submitBtn');
        const outputDiv = document.getElementById('subprocessOutput');
        const statusDiv = document.getElementById('subprocessStatus')
        const form = document.getElementById('crawlForm');

        function enableButton() {
            submitBtn.disabled = false;
        }

        function disableButton() {
            submitBtn.disabled = true;
        }

        socket.addEventListener('open', () => {
            console.log('WebSocket connection established');
            enableButton();
        });

        socket.addEventListener('close', (e) => {
            console.error('WebSocket closed unexpectedly', e);
            disableButton();
        });

        socket.addEventListener('message', (e) => {
            const data = JSON.parse(e.data);
            if (data.message) {
                outputDiv.innerHTML += `<p>${data.message}</p>`;
                outputDiv.scrollTop = outputDiv.scrollHeight;
            }
            if (data.commandCompleted) {
                enableButton();
                statusDiv.innerText = 'Crawl stories completed !!!';
            }
        });

        submitBtn.addEventListener('click', (event) => {
            event.preventDefault();
            disableButton();
            statusDiv.innerText = 'Crawling ...';
            const command = prepareCrawlCommand();
            sendCommand(command);
        });

        function prepareCrawlCommand() {
            const formData = new FormData(form);
            let commandArgs = [];
            for (let [key, value] of formData.entries()) {
                if (key !== 'csrfmiddlewaretoken') {
                    key = key.replace(/_/g, "-");
                    commandArgs.push(`--${key} ${value}`);
                }
            }
            const currentUrl = window.location.href;
            if (currentUrl.includes('crawlliststories')) {
                return `python manage.py crawl_list_stories ${commandArgs.join(' ')}`;
            } else if (currentUrl.includes('crawlsomestories')) {
                return `python manage.py crawl_some_stories ${commandArgs.join(' ')}`;
            } else {
                return null;
            }
        }

        function sendCommand(command) {
            outputDiv.innerHTML = '';
            if (command) {
                socket.send(JSON.stringify({'command': command}));
            } else {
                console.error('No command to run');
                enableButton();
            }
        };
    });
</script>
</body>
</html>