{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Crawl Stories</title>
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/base.css' %}">
</head>
<body>
<form method="post" id="crawlForm">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" id="submitBtn">Crawl Stories</button>
    <div id="subprocessStatus"></div>
</form>

<h2 id="outputLabel">Subprocess Output:</h2>
<div id="subprocessOutput"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const socket = new WebSocket(`ws://${window.location.host}/ws/subprocess/`);
        const submitBtn = document.getElementById('submitBtn');
        const outputDiv = document.getElementById('subprocessOutput');
        const statusDiv = document.getElementById('subprocessStatus')
        const form = document.getElementById('crawlForm');

        function enableButton() {
            submitBtn.disabled = false;
        }

        function disableButton() {
            submitBtn.disabled = true;
        }

        socket.addEventListener('open', () => {
            console.log('WebSocket connection established');
            enableButton();
        });

        socket.addEventListener('close', (e) => {
            console.error('WebSocket closed unexpectedly', e);
            disableButton();
        });

        socket.addEventListener('message', (e) => {
            const data = JSON.parse(e.data);
            if (data.message) {
                outputDiv.innerHTML += `<p>${data.message}</p>`;
            }
            if (data.commandCompleted) {
                enableButton();
                statusDiv.innerText = 'Crawl stories completed !!!';
            }
        });

        submitBtn.addEventListener('click', (event) => {
            event.preventDefault();
            disableButton();
            statusDiv.innerText = 'Crawling ...';
            const command = prepareCrawlCommand();
            sendCommand(command);
        });

        function prepareCrawlCommand() {
            const formData = new FormData(form);
            let commandArgs = [];
            for (let [key, value] of formData.entries()) {
                if (key !== 'csrfmiddlewaretoken') {
                    key = key.replace(/_/g, "-");
                    commandArgs.push(`--${key} ${value}`);
                }
            }
            return `python manage.py crawl_list_stories ${commandArgs.join(' ')}`;
        }

        function sendCommand(command) {
            outputDiv.innerHTML = '';
            if (command) {
                socket.send(JSON.stringify({'command': command}));
            } else {
                console.error('No command to run');
                enableButton();
            }
        };
    });
</script>
</body>
</html>